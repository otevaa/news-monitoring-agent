<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewsMonitor Pro - Tableau de bord</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .stat-number {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <i data-feather="trending-up"></i>
                    </div>
                    NewsMonitor Pro
                </a>
                
                <nav class="nav">
                    <div class="nav-links">
                        <a href="/" class="nav-link active">Dashboard</a>
                        <a href="/campaigns" class="nav-link">Campagnes</a>
                        <a href="/integrations" class="nav-link">Int√©grations</a>
                        <a href="/files" class="nav-link">Fichiers</a>
                        <a href="/analytics" class="nav-link">Analytics</a>
                    </div>
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                        <i data-feather="menu"></i>
                    </button>
                </nav>
                
                <div class="user-menu">
                    {% if session.credentials %}
                        <div class="user-info">
                            <span class="status-badge status-active">Connect√©</span>
                        </div>
                        <a href="/profile" class="btn btn-secondary btn-sm">
                            <i data-feather="user"></i>
                            Profil
                        </a>
                    {% else %}
                        <a href="/auth" class="auth-button">
                            <i data-feather="log-in"></i>
                            Se connecter
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Hero Section -->
            <div class="hero-section" style="text-align: center; margin-bottom: 3rem;">
                <h1 style="font-size: 2.5rem; font-weight: 700; color: var(--neutral-800); margin-bottom: 1rem;">
                    Surveillez l'actualit√© en temps r√©el
                </h1>
                <p style="font-size: 1.125rem; color: var(--neutral-600); max-width: 600px; margin: 0 auto 2rem;">
                    Cr√©ez des campagnes de veille personnalis√©es et recevez automatiquement les articles pertinents dans vos outils pr√©f√©r√©s.
                </p>
                
                {% if not session.credentials %}
                    <a href="/auth" class="btn btn-primary btn-lg">
                        <i data-feather="zap"></i>
                        Commencer maintenant
                    </a>
                {% endif %}
            </div>

            <!-- Alerts -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'warning' else category }}">
                            <strong>{{ 'Succ√®s' if category == 'success' else 'Attention' if category == 'warning' else 'Erreur' }}:</strong> {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            {% if error %}
                <div class="alert alert-error">
                    <strong>Erreur:</strong> {{ error }}
                </div>
            {% endif %}

            {% if success %}
                <div class="alert alert-success">
                    <strong>Succ√®s:</strong> {{ success }}
                </div>
            {% endif %}

            <!-- Quick Search and Campaign Creation -->
            {% if session.credentials %}
            <div class="search-campaign-section" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Quick Search -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Recherche rapide</h2>
                            <p class="card-subtitle">Lancez une recherche ponctuelle</p>
                        </div>
                    </div>
                    
                    <form method="get" action="/veille" class="search-container">
                        <i data-feather="search" class="search-icon"></i>
                        <input 
                            type="text" 
                            name="q" 
                            class="search-input" 
                            placeholder="Saisissez votre mot-cl√© (ex: intelligence artificielle, cybers√©curit√©...)"
                            value="{{ request.args.get('q', '') }}"
                        />
                        <button type="submit" class="btn btn-primary" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);">
                            <i data-feather="search"></i>
                            Rechercher
                        </button>
                    </form>
                </div>
                
                <!-- Campaign Creation -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Nouvelle campagne</h2>
                            <p class="card-subtitle">Automatisez votre veille</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <i data-feather="plus-circle" style="width: 48px; height: 48px; color: var(--primary-blue);"></i>
                        </div>
                        <p style="color: var(--neutral-600); margin-bottom: 1.5rem; font-size: 0.875rem;">
                            Cr√©ez une campagne de veille automatique
                        </p>
                        <a href="/campaigns/create" class="btn btn-primary" style="width: 100%;">
                            <i data-feather="plus"></i>
                            Cr√©er une campagne
                        </a>
                        
                        <!-- Mobile Voice Command Section -->
                        <div class="mobile-voice-section">
                            <div class="mobile-voice-text">Ou utilisez la commande vocale</div>
                            <button class="voice-command-btn" onclick="startVoiceCommand()" title="Commande vocale">
                                <i data-feather="mic"></i>
                                <span class="fallback-icon" style="display: none;">üé§</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Search Section for non-logged users -->
            <div class="search-section">
                <div class="search-header">
                    <h2 class="search-title">Recherche ponctuelle</h2>
                    <p class="search-subtitle">Lancez une recherche ponctuelle</p>
                </div>
                
                <form method="get" action="/veille" class="search-container">
                    <i data-feather="search" class="search-icon"></i>
                    <input 
                        type="text" 
                        name="q" 
                        class="search-input" 
                        placeholder="Saisissez votre mot-cl√© (ex: intelligence artificielle, cybers√©curit√©...)"
                        value="{{ request.args.get('q', '') }}"
                    />
                    <button type="submit" class="btn btn-primary" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);">
                        <i data-feather="search"></i>
                        Rechercher
                    </button>
                </form>
            </div>
            {% endif %}

            <!-- Dashboard Stats -->
            {% if session.credentials %}
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-feather="target"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-number" id="active-campaigns">{{ stats.active_campaigns or 0 }}</span>
                            <span class="stat-label">Campagnes actives</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-feather="file-text"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-number" id="total-articles">{{ stats.total_articles or 0 }}</span>
                            <span class="stat-label">Articles collect√©s</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-feather="calendar"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-number" id="articles-today">{{ stats.articles_today or 0 }}</span>
                            <span class="stat-label">Aujourd'hui</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i data-feather="archive"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-number" id="total-campaigns">{{ stats.total_campaigns or 0 }}</span>
                            <span class="stat-label">Total campagnes</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Campaigns and Integration Status -->
            <div class="dashboard-grid">
                <!-- Recent Campaigns -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Campagnes r√©centes</h2>
                    </div>
                    
                    {% if campaigns %}
                    <div class="campaign-accordion">
                        {% for campaign in campaigns[:5] %}
                        <div class="accordion-item" data-campaign-id="{{ campaign.id }}">
                            <div class="accordion-header" onclick="toggleAccordion('accordion-{{ loop.index }}')">
                                <div class="campaign-header-info">
                                    <h4>{{ campaign.name }}</h4>
                                    <span class="campaign-frequency">{{ campaign.frequency }}</span>
                                    <span class="status-badge status-{{ campaign.status }}">{{ campaign.status }}</span>
                                </div>
                                <button class="accordion-toggle">
                                    <i data-feather="chevron-down"></i>
                                </button>
                            </div>
                            
                            <div id="accordion-{{ loop.index }}" class="accordion-content">
                                <div class="accordion-body">
                                    <div class="campaign-details">
                                        <div class="detail-item">
                                            <i data-feather="search"></i>
                                            <span><strong>Mots-cl√©s:</strong> {{ campaign.keywords }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <i data-feather="file"></i>
                                            <span><strong>Articles collect√©s:</strong> <span class="total-articles">{{ campaign.total_articles or 0 }}</span></span>
                                        </div>
                                        <div class="detail-item">
                                            <i data-feather="calendar"></i>
                                            <span><strong>Cr√©√©e le:</strong> {{ campaign.created_at[:10] if campaign.created_at else 'N/A' }}</span>
                                        </div>
                                        {% if campaign.last_check %}
                                        <div class="detail-item">
                                            <i data-feather="clock"></i>
                                            <span><strong>Derni√®re v√©rification:</strong> <span class="last-check">{{ campaign.last_check[:16] if campaign.last_check else 'Jamais' }}</span></span>
                                        </div>
                                        {% endif %}
                                        <div class="detail-item">
                                            <i data-feather="target"></i>
                                            <span><strong>Aujourd'hui:</strong> <span class="articles-today">{{ campaign.articles_today or 0 }}</span> articles</span>
                                        </div>
                                        {% if campaign.spreadsheet_url %}
                                        <div class="detail-item">
                                            <i data-feather="grid"></i>
                                            <span><strong>Feuille associ√©e:</strong> 
                                                <a href="{{ campaign.spreadsheet_url }}" target="_blank" style="color: var(--primary-blue); text-decoration: none;">
                                                    Ouvrir la feuille Google Sheets
                                                </a>
                                            </span>
                                        </div>
                                        {% endif %}
                                        {% if campaign.last_execution %}
                                        <div class="detail-item">
                                            <i data-feather="zap"></i>
                                            <span><strong>Derni√®re ex√©cution:</strong> {{ campaign.last_execution[:10] }}</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="campaign-actions-panel">
                                        <a href="/campaigns/{{ campaign.id }}/edit" class="btn btn-secondary btn-sm">
                                            <i data-feather="edit"></i>
                                            Modifier
                                        </a>
                                        {% if campaign.status == 'active' %}
                                            <button class="btn btn-warning btn-sm" onclick="pauseCampaign('{{ campaign.id }}')">
                                                <i data-feather="pause"></i>
                                                Pause
                                            </button>
                                        {% elif campaign.status == 'paused' %}
                                            <button class="btn btn-success btn-sm" onclick="resumeCampaign('{{ campaign.id }}')">
                                                <i data-feather="play"></i>
                                                Reprendre
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-danger btn-sm" onclick="deleteCampaign('{{ campaign.id }}')">
                                            <i data-feather="trash-2"></i>
                                            Supprimer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if campaigns|length > 5 %}
                    <div style="text-align: center; margin-top: 1rem;">
                        <a href="/campaigns" class="btn btn-secondary">
                            Voir toutes les campagnes
                        </a>
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div style="text-align: center; padding: 2rem; color: var(--neutral-500);">
                        <i data-feather="inbox" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                        <p>Aucune campagne pour le moment</p>
                        <a href="/campaigns/create" class="btn btn-primary" style="margin-top: 1rem;">
                            <i data-feather="plus"></i>
                            Cr√©er votre premi√®re campagne
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Integration Status -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Int√©grations</h2>
                        <a href="/integrations" class="btn btn-secondary btn-sm">
                            <i data-feather="settings"></i>
                            G√©rer
                        </a>
                    </div>
                    
                    <div class="integration-dashboard-grid">
                        <div class="integration-dashboard-item">
                            <div class="integration-dashboard-content">
                                <div class="integration-icon" style="background: linear-gradient(135deg, #4285f4, #34a853); color: white;">
                                    <i data-feather="grid"></i>
                                </div>
                                <div class="integration-dashboard-info">
                                    <h4>Google Sheets</h4>
                                    <p class="integration-description">Synchronisation automatique des articles</p>
                                    {% if integrations.google_sheets %}
                                        <span class="status-badge status-active">Connect√©</span>
                                        {% if integrations.google_sheets.total_records %}
                                        <div class="integration-stats">
                                            <span>{{ integrations.google_sheets.total_records }} articles sync.</span>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="status-badge status-inactive">Non connect√©</span>
                                        <a href="/auth" class="btn btn-primary btn-xs" style="margin-top: 0.5rem;">Connecter</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="integration-dashboard-item">
                            <div class="integration-dashboard-content">
                                <div class="integration-icon" style="background: linear-gradient(135deg, #ff6900, #ff8533); color: white;">
                                    <i data-feather="database"></i>
                                </div>
                                <div class="integration-dashboard-info">
                                    <h4>Airtable</h4>
                                    <p class="integration-description">Base de donn√©es structur√©e</p>
                                    {% if integrations.airtable %}
                                        <span class="status-badge status-active">Connect√©</span>
                                        {% if integrations.airtable.total_records %}
                                        <div class="integration-stats">
                                            <span>{{ integrations.airtable.total_records }} enregistrements</span>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="status-badge status-inactive">Non connect√©</span>
                                        <a href="/integrations" class="btn btn-primary btn-xs" style="margin-top: 0.5rem;">Configurer</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Auto-refresh Status -->
                    <div style="grid-column: 1 / -1; margin-top: 1rem; padding: 0.75rem; background: rgba(66, 133, 244, 0.05); border-radius: var(--radius-md); border: 1px solid rgba(66, 133, 244, 0.1);">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: var(--neutral-600); font-size: 0.875rem;">
                            <div style="width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%; animation: pulse 2s infinite;"></div>
                            <span>Mise √† jour automatique active</span>
                            <span id="last-update-time">Derni√®re mise √† jour: Chargement...</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Search Results -->
            {% if articles %}
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">R√©sultats de recherche</h2>
                    <span class="card-subtitle">{{ articles|length }} articles trouv√©s pour "{{ request.args.get('q') }}"</span>
                </div>
                
                <div style="display: grid; gap: 1rem;">
                    {% for article in articles %}
                    <div class="card" style="padding: 1.5rem; border-left: 4px solid var(--primary-blue);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
                                    <a href="{{ article.url }}" target="_blank" style="color: var(--neutral-800); text-decoration: none;">
                                        {{ article.titre }}
                                    </a>
                                </h3>
                                <div style="font-size: 0.875rem; color: var(--neutral-500); display: flex; gap: 1rem; align-items: center;">
                                    <span style="display: flex; align-items: center; gap: 0.25rem;">
                                        <i data-feather="calendar" style="width: 14px; height: 14px;"></i>
                                        {{ article.date[:10] }}
                                    </span>
                                    <span style="display: flex; align-items: center; gap: 0.25rem;">
                                        <i data-feather="globe" style="width: 14px; height: 14px;"></i>
                                        {{ article.source }}
                                    </span>
                                </div>
                            </div>
                            <a href="{{ article.url }}" target="_blank" class="btn btn-secondary btn-sm">
                                <i data-feather="external-link"></i>
                                Lire
                            </a>
                        </div>
                        <p style="color: var(--neutral-600); line-height: 1.6;">{{ article.resume }}</p>
                    </div>
                    {% endfor %}
                </div>

                {% if articles %}
                <div style="text-align: center; margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <a href="/campaigns/create?keywords={{ request.args.get('q') }}" class="btn btn-primary">
                        <i data-feather="bookmark"></i>
                        Cr√©er une campagne avec ces mots-cl√©s
                    </a>
                    {% if session.credentials %}
                    <button onclick="saveSearchResults()" class="btn btn-secondary">
                        <i data-feather="download"></i>
                        Sauvegarder dans Google Sheets
                    </button>
                    <script>
                        window.searchArticles = {{ articles | tojson | safe }};
                    </script>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Error Message -->
            {% if error %}
            <div class="alert alert-error">
                <i data-feather="alert-circle"></i>
                {{ error }}
            </div>
            {% endif %}
        </div>
    </main>

    <script>
        // Initialize Feather icons when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeFeatherIcons();
        });
        
        // Also initialize immediately
        initializeFeatherIcons();
        
        function initializeFeatherIcons() {
            try {
                feather.replace();
                console.log('Feather icons initialized');
                
                // Check if icons loaded properly, if not show fallback
                setTimeout(() => {
                    const voiceBtn = document.querySelector('.voice-command-btn');
                    const micIcon = voiceBtn.querySelector('[data-feather="mic"]');
                    const fallbackIcon = voiceBtn.querySelector('.fallback-icon');
                    
                    if (micIcon && (micIcon.innerHTML === '' || micIcon.tagName === 'I')) {
                        // Icon didn't load, show fallback
                        micIcon.style.display = 'none';
                        fallbackIcon.style.display = 'inline-block';
                        console.log('Using fallback icon for voice command');
                    }
                }, 100);
                
            } catch (error) {
                console.error('Failed to initialize Feather icons:', error);
                // Show fallback icons
                const fallbackIcons = document.querySelectorAll('.fallback-icon');
                fallbackIcons.forEach(icon => {
                    icon.style.display = 'inline-block';
                    icon.previousElementSibling.style.display = 'none';
                });
            }
        }

        // Campaign management functions
        function pauseCampaign(campaignId) {
            if (confirm('Mettre en pause cette campagne ?')) {
                fetch(`/campaigns/${campaignId}/pause`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur lors de la mise en pause');
                        }
                    });
            }
        }

        function resumeCampaign(campaignId) {
            fetch(`/campaigns/${campaignId}/resume`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erreur lors de la reprise');
                    }
                });
        }

        function deleteCampaign(campaignId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette campagne ?')) {
                fetch(`/campaigns/${campaignId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Erreur lors de la suppression');
                        }
                    });
            }
        }
        
        // Accordion functionality
        function toggleAccordion(accordionId) {
            const content = document.getElementById(accordionId);
            const header = content.previousElementSibling;
            const isActive = content.classList.contains('active');
            
            // Close all other accordions
            document.querySelectorAll('.accordion-content').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.classList.remove('active');
            });
            
            // Toggle current accordion
            if (!isActive) {
                content.classList.add('active');
                header.classList.add('active');
            }
        }
        
        // Spreadsheet management functions
        function showSpreadsheetDialog(campaignId, articles) {
            // Store articles globally for access in saveResults
            window.currentArticles = articles;
            
            // Create modal dialog for spreadsheet selection
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-header">
                        <h3>Sauvegarder les r√©sultats</h3>
                        <button onclick="closeModal()" class="btn-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 1rem; color: var(--neutral-600);">
                            ${articles.length} article(s) √† sauvegarder
                        </p>
                        <div class="form-group">
                            <label>Choisissez une option:</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="spreadsheet_choice" value="new" checked>
                                    Cr√©er une nouvelle feuille de calcul
                                </label>
                                <label>
                                    <input type="radio" name="spreadsheet_choice" value="existing">
                                    Utiliser une feuille existante
                                </label>
                            </div>
                        </div>
                        <div id="existing-spreadsheet-options" style="display: none;">
                            <select id="spreadsheet-select" class="form-control">
                                <option value="">Chargement...</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeModal()" class="btn btn-secondary">Annuler</button>
                        <button onclick="saveResults('${campaignId}')" class="btn btn-primary">Sauvegarder</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load existing spreadsheets
            loadSpreadsheets();
            
            // Handle radio button changes
            document.querySelectorAll('input[name="spreadsheet_choice"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const existingOptions = document.getElementById('existing-spreadsheet-options');
                    if (this.value === 'existing') {
                        existingOptions.style.display = 'block';
                    } else {
                        existingOptions.style.display = 'none';
                    }
                });
            });
        }
        
        function loadSpreadsheets() {
            fetch('/api/spreadsheets/list')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('spreadsheet-select');
                    select.innerHTML = '<option value="">S√©lectionnez une feuille</option>';
                    
                    if (data.spreadsheets) {
                        data.spreadsheets.forEach(sheet => {
                            const option = document.createElement('option');
                            option.value = sheet.id;
                            option.textContent = sheet.name;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading spreadsheets:', error);
                    document.getElementById('spreadsheet-select').innerHTML = '<option value="">Erreur de chargement</option>';
                });
        }
        
        function saveResults(campaignId) {
            const choice = document.querySelector('input[name="spreadsheet_choice"]:checked').value;
            const spreadsheetId = choice === 'existing' ? document.getElementById('spreadsheet-select').value : null;
            
            if (choice === 'existing' && !spreadsheetId) {
                alert('Veuillez s√©lectionner une feuille de calcul');
                return;
            }
            
            const articles = window.currentArticles || [];
            
            // For search results, create a custom campaign name
            const campaignName = campaignId === 'search-results' ? 
                `Recherche: ${new URLSearchParams(window.location.search).get('q') || 'R√©sultats'}` : 
                campaignId;
            
            const endpoint = campaignId === 'search-results' ? 
                '/api/search-results/save' : 
                `/api/campaigns/${campaignId}/save-results`;
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    spreadsheet_choice: choice,
                    spreadsheet_id: spreadsheetId,
                    articles: articles,
                    campaign_name: campaignName,
                    keywords: new URLSearchParams(window.location.search).get('q') || ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('R√©sultats sauvegard√©s avec succ√®s!');
                    closeModal();
                    if (data.spreadsheet_url) {
                        window.open(data.spreadsheet_url, '_blank');
                    }
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Error saving results:', error);
                alert('Erreur lors de la sauvegarde');
            });
        }
        
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        // Function to save search results
        function saveSearchResults() {
            if (typeof window.searchArticles !== 'undefined') {
                showSpreadsheetDialog('search-results', window.searchArticles);
            } else {
                alert('Aucun article √† sauvegarder');
            }
        }

        // Auto-refresh campaign statistics
        function updateCampaignStats() {
            fetch('/api/campaigns/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update overall statistics
                        updateStatCard('total-campaigns', data.stats.total_campaigns);
                        updateStatCard('active-campaigns', data.stats.active_campaigns);
                        updateStatCard('total-articles', data.stats.total_articles);
                        updateStatCard('articles-today', data.stats.articles_today);
                        
                        // Update individual campaign cards
                        data.campaigns.forEach(campaign => {
                            updateCampaignCard(campaign);
                        });
                        
                        // Update last refresh time
                        const lastUpdateEl = document.getElementById('last-update-time');
                        if (lastUpdateEl) {
                            const now = new Date();
                            lastUpdateEl.textContent = `Derni√®re mise √† jour: ${now.toLocaleTimeString()}`;
                        }
                        
                        console.log('Campaign stats updated successfully');
                    }
                })
                .catch(error => {
                    console.error('Error updating campaign stats:', error);
                });
        }
        
        function updateStatCard(id, value) {
            const element = document.getElementById(id);
            if (element) {
                // Add animation effect
                element.style.transform = 'scale(1.1)';
                element.textContent = value;
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 200);
            }
        }
        
        function updateCampaignCard(campaign) {
            const cardElement = document.querySelector(`[data-campaign-id="${campaign.id}"]`);
            if (cardElement) {
                // Update total articles
                const totalArticlesEl = cardElement.querySelector('.total-articles');
                if (totalArticlesEl && totalArticlesEl.textContent !== campaign.total_articles.toString()) {
                    totalArticlesEl.style.color = 'var(--accent-green)';
                    totalArticlesEl.textContent = campaign.total_articles;
                    setTimeout(() => {
                        totalArticlesEl.style.color = 'var(--primary-blue)';
                    }, 1000);
                }
                
                // Update articles today
                const todayArticlesEl = cardElement.querySelector('.articles-today');
                if (todayArticlesEl && todayArticlesEl.textContent !== campaign.articles_today.toString()) {
                    todayArticlesEl.style.color = 'var(--accent-green)';
                    todayArticlesEl.textContent = campaign.articles_today;
                    setTimeout(() => {
                        todayArticlesEl.style.color = 'var(--accent-green)';
                    }, 1000);
                }
                
                // Update last check time
                const lastCheckEl = cardElement.querySelector('.last-check');
                if (lastCheckEl && campaign.last_check) {
                    const formattedTime = campaign.last_check.substring(0, 16).replace('T', ' ');
                    lastCheckEl.textContent = formattedTime;
                }
            }
        }
        
        // Start auto-refresh when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initial update
            updateCampaignStats();
            
            // Set up periodic updates every 30 seconds
            setInterval(updateCampaignStats, 30000);
            
            console.log('Auto-refresh initialized - updating every 30 seconds');
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('active');
        }

        // Voice command functionality
        let recognition;
        let isListening = false;
        let currentTranscript = '';

        function startVoiceCommand() {
            console.log('üé§ Voice command button clicked!');
            
            // Check for speech recognition support
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Votre navigateur ne supporte pas la reconnaissance vocale. Utilisez Chrome, Edge ou Safari.');
                return;
            }

            const modal = document.getElementById('voiceModal');
            const status = document.getElementById('voiceStatus');
            const transcript = document.getElementById('voiceTranscript');
            const btn = document.querySelector('.voice-command-btn');
            const executeBtn = document.getElementById('executeBtn');

            if (!modal) {
                console.error('‚ùå Modal not found!');
                alert('Erreur: Modal introuvable');
                return;
            }

            console.log('‚úÖ Modal elements found:', { modal, status, transcript, btn, executeBtn });

            // Show modal and reset state
            modal.style.display = 'flex';
            status.textContent = 'Pr√©paration de l\'√©coute...';
            transcript.textContent = '';
            executeBtn.style.display = 'none';
            currentTranscript = '';

            // Initialize speech recognition directly
            try {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'fr-FR';
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 5;
                
                console.log('‚úÖ Speech recognition initialized');
                
                // Add the listening class when starting
                btn.classList.add('listening');
            
                recognition.onstart = function() {
                    console.log('‚úÖ Speech recognition started');
                    status.textContent = '√âcoute en cours... Parlez maintenant !';
                    isListening = true;
                };

                recognition.onresult = function(event) {
                    console.log('‚úÖ Speech recognition result received:', event);
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];
                        const resultText = result[0].transcript;
                        
                        console.log(`üìù Result ${i}: "${resultText}" (final: ${result.isFinal})`);
                        
                        if (result.isFinal) {
                            finalTranscript += resultText;
                        } else {
                            interimTranscript += resultText;
                        }
                    }

                    const displayTranscript = finalTranscript || interimTranscript;
                    console.log('üìù Updating transcript display:', displayTranscript);
                    
                    // Update the transcript display
                    transcript.textContent = displayTranscript;
                    
                    if (interimTranscript) {
                        status.textContent = 'En cours de reconnaissance...';
                    }

                    if (finalTranscript) {
                        currentTranscript = finalTranscript.trim();
                        status.textContent = 'Commande re√ßue ! Vous pouvez l\'ex√©cuter.';
                        executeBtn.style.display = 'inline-block';
                        btn.classList.remove('listening');
                        console.log('‚úÖ Final transcript:', currentTranscript);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('‚ùå Speech recognition error:', event.error);
                    let errorMessage = '';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'Aucune parole d√©tect√©e. Parlez plus fort et r√©essayez.';
                            break;
                        case 'audio-capture':
                            errorMessage = 'Microphone non disponible. V√©rifiez vos param√®tres.';
                            break;
                        case 'not-allowed':
                            errorMessage = 'Permission microphone refus√©e. Autorisez le microphone et r√©essayez.';
                            break;
                        case 'network':
                            errorMessage = 'Erreur r√©seau. V√©rifiez votre connexion.';
                            break;
                        case 'aborted':
                            errorMessage = 'Reconnaissance interrompue.';
                            break;
                        default:
                            errorMessage = `Erreur: ${event.error}. R√©essayez.`;
                    }
                    status.textContent = errorMessage;
                    btn.classList.remove('listening');
                    isListening = false;
                };

                recognition.onend = function() {
                    console.log('‚úÖ Speech recognition ended');
                    btn.classList.remove('listening');
                    isListening = false;
                    
                    if (!currentTranscript) {
                        status.textContent = 'Aucune commande d√©tect√©e. Parlez plus clairement et r√©essayez.';
                        setTimeout(() => {
                            status.textContent = 'Essayez: "Cr√©er une campagne" ou "Nouvelle campagne"';
                        }, 2000);
                    }
                };

                // Start recognition
                console.log('üé§ Starting speech recognition...');
                recognition.start();
                
            } catch (error) {
                console.error('‚ùå Error starting speech recognition:', error);
                status.textContent = 'Erreur lors de l\'initialisation. V√©rifiez vos param√®tres de microphone.';
                btn.classList.remove('listening');
                alert('Erreur: ' + error.message);
            }
        }

        function stopVoiceCommand() {
            if (recognition) {
                recognition.stop();
            }
            document.getElementById('voiceModal').style.display = 'none';
            document.querySelector('.voice-command-btn').classList.remove('listening');
            isListening = false;
            currentTranscript = '';
        }

        function executeVoiceCommand() {
            if (!currentTranscript) return;

            const command = currentTranscript.toLowerCase().trim();
            console.log('Executing command:', command);

            // Parse voice commands for campaign creation
            if (command.includes('cr√©er') || command.includes('creer') || command.includes('nouvelle campagne') || command.includes('campagne')) {
                parseCreateCampaignCommand(command);
            } else if (command.includes('dashboard') || command.includes('tableau de bord') || command.includes('accueil')) {
                window.location.href = '/';
            } else if (command.includes('campagnes') || command.includes('liste')) {
                window.location.href = '/campaigns';
            } else if (command.includes('int√©grations') || command.includes('integrations')) {
                window.location.href = '/integrations';
            } else if (command.includes('fichiers') || command.includes('files')) {
                window.location.href = '/files';
            } else if (command.includes('profil') || command.includes('profile')) {
                window.location.href = '/profile';
            } else {
                // If no specific command recognized, try to create a campaign anyway
                if (command.length > 3) {
                    alert(`Commande "${command}" interpr√©t√©e comme cr√©ation de campagne. Redirection...`);
                    parseCreateCampaignCommand(command);
                } else {
                    alert('Commande non reconnue. Essayez: "Cr√©er une nouvelle campagne", "Aller aux campagnes", "Dashboard", etc.');
                }
            }

            stopVoiceCommand();
        }

        function parseCreateCampaignCommand(command) {
            // Extract campaign details from voice command
            let campaignName = '';
            let keywords = '';
            let frequency = 'daily'; // default daily

            // Simple parsing - can be enhanced
            if (command.includes('pour') || command.includes('sur')) {
                const parts = command.split(/pour|sur/);
                if (parts.length > 1) {
                    keywords = parts[1].trim().replace(/[.,!?]/g, '');
                    campaignName = `Campagne ${keywords}`;
                }
            } else {
                // If no specific keywords, use the whole command as keywords
                keywords = command.replace(/cr√©er|creer|nouvelle|campagne|une|de|veille/gi, '').trim();
                campaignName = `Campagne vocale ${new Date().getTime()}`;
            }

            if (command.includes('horaire') || command.includes('heure') || command.includes('toutes les heures')) {
                frequency = 'hourly';
            } else if (command.includes('quotidien') || command.includes('jour') || command.includes('quotidienne')) {
                frequency = 'daily';
            } else if (command.includes('hebdomadaire') || command.includes('semaine')) {
                frequency = 'weekly';
            }

            // Redirect to create campaign with pre-filled data
            const params = new URLSearchParams({
                name: campaignName || 'Nouvelle campagne vocale',
                keywords: keywords || 'actualit√©s',
                frequency: frequency
            });
            
            window.location.href = `/campaigns/create?${params.toString()}`;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('voiceModal');
            if (event.target == modal) {
                stopVoiceCommand();
            }
        }
    </script>

    <!-- Voice Command Feature -->
    <div class="voice-command-container">
        <button class="voice-command-btn" onclick="startVoiceCommand()" title="Commande vocale">
            <i data-feather="mic"></i>
            <span class="fallback-icon" style="display: none;">üé§</span>
        </button>
    </div>

    <!-- Voice Command Modal -->
    <div class="voice-modal" id="voiceModal">
        <div class="voice-modal-content">
            <h3>Commande vocale</h3>
            <div class="voice-status" id="voiceStatus">Cliquez pour commencer</div>
            <div class="voice-transcript" id="voiceTranscript">En attente...</div>
            <div style="margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="stopVoiceCommand()">Arr√™ter</button>
                <button class="btn btn-primary" onclick="executeVoiceCommand()" id="executeBtn" style="display: none;">Ex√©cuter</button>
            </div>
        </div>
    </div>

